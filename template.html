<!DOCTYPE html>
<html>
<head>
  <title><?=$_config['title']?></title>
  <meta charset="UTF-8">
  <meta name="description" content="Short URL">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
  <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <a class="navbar-brand" href='/'><?=$_config['title']?></a>
<?php if (isset($all_records)) : ?>
    <a href="#" class="btn btn-primary" id="getip">Get IP</a>
<?php endif; ?>
  </nav>

  <div id="canvas" style="padding: 1em;">



<?php foreach ( $alerts as $e ) : ?>
    <div class="alert alert-<?=$e[0]?>" role="alert">
      <?=$e[1]?>
    </div>
<?php endforeach ?>




<?php if (!isset($all_records)) : ?>

<!-- New UrlPair Mode -->
    <?php
      $var1 = rand(10,30);
      $var2 = rand(10,30);
      $_SESSION['verify'] = $var1 + $var2;
    ?>

    <form action="/_newurl" method="post">
      <div class="form-group">
        <label for="tb_title">Title</label>
        <input type="text" class="form-control" id="tb_title" aria-describedby="" name='title'>
        <small class="form-text text-muted">Optional Title for redirect page.</small>
      </div>
      <div class="form-group">
        <label for="tb_shortUrl">Preferred Short URL</label>
        <input type="text" class="form-control" id="tb_shortUrl" aria-describedby="" name='short_url'>
        <small class="form-text text-muted">If not specified, a random string will be generated.</small>
      </div>
      <div class="form-group">
        <label for="tb_longUrl">Your Long URL</label>
        <input type="text" class="form-control" id="tb_longUrl" aria-describedby="" name='long_url' placeholder="https://..." required>
        <small class="form-text text-muted">Required. Short URL will redirect to this long URL.</small>
      </div>
      <div class="form-group">
        <label for="tb_verify">What is the result of <?=$var1?>+<?=$var2?> ?</label>
        <input type="text" class="form-control" id="tb_verify" aria-describedby="" name='verify' placeholder="" required>
        <small class="form-text text-muted"></small>
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary" id="btn_continue">Create Link</button>
      </div>
    </form>

<!-- End New UrlPair Mode -->



<?php else : ?>



<!-- View Record Mode -->

<style>
body { font-size: 0.8rem; }
th { text-align: left; }
</style>

<?php   if (!empty($all_records)) : ?>
<table class="table table-sm table-hover">
  <tr>
<?php     foreach($all_records[0] as $field => $value) : ?>
    <th><?=$field?></th>
<?php     endforeach ?>
  </tr>
<?php     foreach($all_records as $pair) : ?>
  <tr>
<?php       foreach ($pair as $field => $value) : ?>
<?php         if ($field == 'long_url') : ?>
    <td><a href="<?=$pair['long_url']?>" target="_blank"><?=$pair['long_url']?></a></td>
<?php         elseif ($field == 'remote_ip') : ?>
    <td class="ip_grid" id="ip_<?=$pair['id']?>"><?=$value?></td>
<?php         else : ?>
    <td><?=$value?></td>
<?php         endif ?>
<?php       endforeach ?>
  </tr>
<?php     endforeach ?>
</table>
<?php   else : ?>
  No Records.
<?php   endif ?>



<script src="http://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
  $(document).ready(function() {

    $("#getip").click(function () {
      $( ".ip_grid" ).each(function() {
        var id = $(this).prop('id');
        $.get('/checkip.php', { ip: $(this).text() })
          .done(function(data) {
            $("#"+id).prop('title', data);
        });
      });

      return false;
    });

  });
</script>

<!-- End View Record Mode -->

<?php endif ?>




  </div>
</body>
</html>
